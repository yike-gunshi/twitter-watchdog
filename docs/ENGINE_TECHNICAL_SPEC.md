# Twitter Watchdog å¼•æ“æŠ€æœ¯è§„æ ¼

> æ•°æ®æŠ“å– â†’ AI åˆ†æ â†’ æŠ¥å‘Šç”Ÿæˆ å…¨é“¾è·¯æŠ€æœ¯ç»†èŠ‚

---

## ç›®å½•

- [0. åˆå§‹åŒ–](#0-åˆå§‹åŒ–)
- [1. Layer 1: æ•°æ®æŠ“å– (Scrape)](#1-layer-1-æ•°æ®æŠ“å–-scrape)
- [2. Layer 2: AI åˆ†æ (Analyze)](#2-layer-2-ai-åˆ†æ-analyze)
- [3. Layer 3: æŠ¥å‘Šç”Ÿæˆ (Report)](#3-layer-3-æŠ¥å‘Šç”Ÿæˆ-report)
- [4. æµæ°´çº¿ (Pipeline)](#4-æµæ°´çº¿-pipeline)
- [5. å…¨éƒ¨å¯é…ç½®å‚æ•°](#5-å…¨éƒ¨å¯é…ç½®å‚æ•°)
- [6. å®Œæ•´æ•°æ®æµ](#6-å®Œæ•´æ•°æ®æµ)

---

## 0. åˆå§‹åŒ–

**å…¥å£**: `TwitterWatchdog.__init__()` (twitter_watchdog.py:54-94)

åˆå§‹åŒ–é¡ºåºï¼š
1. åŠ è½½ YAML é…ç½®æ–‡ä»¶
2. è®¾ç½® `self.hours_ago = None`
3. åº”ç”¨ CLI å‚æ•°è¦†ç›–
4. æå–å­é…ç½®ï¼š`twitter`ã€`output`ã€`filters`ã€`notifications`ã€`advanced`
5. å¦‚æœä¸æ˜¯ `report_only` æ¨¡å¼ï¼š
   - æå– `twitterapi_io.api_key`
   - æå– `twitter_api.consumer_key/secret`
   - å¦‚æœä¸¤ä¸ª consumer å‡­è¯éƒ½å­˜åœ¨ï¼Œç”Ÿæˆ Bearer Tokenï¼ˆå¤±è´¥ä¸è‡´å‘½ï¼‰
   - è®¾ç½® HTTP è¶…æ—¶ï¼ˆé»˜è®¤ 30 ç§’ï¼‰
   - åŠ è½½å»é‡çŠ¶æ€æ–‡ä»¶

### Bearer Token ç”Ÿæˆ

```
POST https://api.twitter.com/oauth2/token
Headers: Authorization: Basic <base64(consumer_key:consumer_secret)>
Body: grant_type=client_credentials
```

### CLI å‚æ•°è¦†ç›–æ˜ å°„

| CLI å‚æ•° | æ˜ å°„åˆ° | è¯´æ˜ |
|----------|--------|------|
| `--hours-ago N` | `self.hours_ago` | ç›´æ¥å±æ€§ï¼Œä¸åœ¨ config å†… |
| `--max-followings N` | `advanced.max_followings` | |
| `--tweets-per-user N` | `twitter.tweets_per_user` | |
| `--trending-count N` | `trending_search.max_tweets` | |
| `--trending-query STR` | `trending_search.query` | æ—§çš„å•æŸ¥è¯¢æ ¼å¼ |
| `--min-faves N` | `trending_search.min_views` | æ³¨æ„ï¼šCLI å« favesï¼Œå®é™…æ˜ å°„åˆ° min_views |
| `--language LANG` | `filters.language` | |
| `--exclude-users "a,b"` | `twitter.exclude_users` | é€—å·åˆ†éš”è½¬åˆ—è¡¨ |
| `--output-dir PATH` | `output.directory` | |
| `--no-trending` | `trending_search.enabled = False` | |
| `--no-summary` | `ai_summary.enabled = False` | |

---

## 1. Layer 1: æ•°æ®æŠ“å– (Scrape)

**å…¥å£**: `run_scrape()` (twitter_watchdog.py:1160-1273)

### 1.1 è·å–å…³æ³¨åˆ—è¡¨

**æ–¹æ³•**: `get_following()` (lines 294-336)

**ç¼“å­˜ç­–ç•¥**ï¼š
- æ£€æŸ¥ state æ–‡ä»¶ä¸­çš„ `followings_cache` å’Œ `followings_updated`
- å¦‚æœç¼“å­˜æ—¶é—´åœ¨ `followings_cache_hours`ï¼ˆé»˜è®¤ 24 å°æ—¶ï¼‰å†…ï¼Œç›´æ¥ä½¿ç”¨ç¼“å­˜
- æ‰“å°ï¼š`"ä½¿ç”¨ç¼“å­˜çš„å…³æ³¨åˆ—è¡¨ï¼ˆN äººï¼‰"`

**ä¸»è·¯å¾„ â€” twitterapi.io**ï¼ˆ`_get_followings_twitterapiio`ï¼Œlines 221-252ï¼‰ï¼š

```
GET https://api.twitterapi.io/twitter/user/followings
Headers: X-API-Key: <api_key>
Params: userName=<username>, pageSize=200, cursor=<cursor>
```

- è‡ªåŠ¨ç¿»é¡µï¼Œæ¯é¡µæœ€å¤š 200 äºº
- å­—æ®µæ ‡å‡†åŒ–ï¼š`userName â†’ username`ï¼Œ`screen_name â†’ username`
- åœæ­¢æ¡ä»¶ï¼šè¾¾åˆ° `max_followings`ï¼Œæˆ– `has_next_page = false`

**å¤‡ç”¨è·¯å¾„ â€” X Official API**ï¼ˆ`_get_followings_x_api`ï¼Œlines 254-292ï¼‰ï¼š

ä»…åœ¨ twitterapi.io å¤±è´¥ä¸” `bearer_token` å­˜åœ¨æ—¶è§¦å‘ã€‚

```
Step 1: GET https://api.twitter.com/2/users/by/username/{username}
Step 2: GET https://api.twitter.com/2/users/{user_id}/following
  Params: max_results=1000, user.fields=username,name,description,public_metrics
  ç¿»é¡µ: pagination_token
```

- 429 é™æµå¤„ç†ï¼šè¯»å– `x-rate-limit-reset` headerï¼Œç­‰å¾…åˆ°é‡ç½®æ—¶é—´
- æ¯ä¸ªè¯·æ±‚æœ€å¤šé‡è¯• `retry_attempts`ï¼ˆé»˜è®¤ 3ï¼‰æ¬¡

**ç¼“å­˜æ›´æ–°**ï¼šè·å–æˆåŠŸåä¿å­˜åˆ° state æ–‡ä»¶

**æ’é™¤ç”¨æˆ·**ï¼šä»ç»“æœä¸­ç§»é™¤ `twitter.exclude_users` åˆ—è¡¨ä¸­çš„ç”¨æˆ·å

### 1.2 åˆå¹¶è‡ªå®šä¹‰è´¦å·

**ä½ç½®**: lines 1177-1192

éå† `twitter.custom_accounts` åˆ—è¡¨ï¼š
- å¦‚æœç”¨æˆ·åï¼ˆå°å†™ï¼‰ä¸åœ¨å…³æ³¨åˆ—è¡¨ä¸­
- æ·»åŠ ä¸€æ¡åˆæˆè®°å½•ï¼š`{"username": acct, "name": acct, "_custom": True, ...}`
- æ‰“å°ï¼š`"+ N ä¸ªè‡ªå®šä¹‰è´¦å·"`

### 1.3 é€ç”¨æˆ·æŠ“å–æ¨æ–‡

**æ–¹æ³•**: `get_tweets(username)` (lines 355-417)

```
GET https://api.twitterapi.io/twitter/user/last_tweets
Headers: X-API-Key: <api_key>
Params: userName=<username>, cursor=<cursor>
```

**ç¿»é¡µé€»è¾‘**ï¼ˆæœ€å¤š 10 é¡µï¼‰ï¼š
1. æ¯é¡µæå– `data.tweets` æˆ– `tweets`ï¼ˆå…¼å®¹ä¸¤ç§å“åº”æ ¼å¼ï¼‰
2. è¿‡æ»¤è½¬æ¨ï¼šå¦‚æœ `exclude_retweets=true`ï¼Œæ’é™¤ `type=="retweet"` æˆ–æ–‡æœ¬ä»¥ `"RT @"` å¼€å¤´çš„
3. è¿‡æ»¤å›å¤ï¼šå¦‚æœ `exclude_replies=true`ï¼Œæ’é™¤ `isReply==True` çš„
4. è®°å½•æ¯é¡µæœ€æ—©æ¨æ–‡çš„æ—¶é—´æˆ³
5. **æ˜¯å¦ç»§ç»­ç¿»é¡µ**ï¼šåªæœ‰ `hours_ago` è®¾ç½®äº†ä¸”æœ€æ—©æ¨æ–‡åœ¨æ—¶é—´çª—å£å†…ä¸”æœ‰ `next_cursor` æ—¶æ‰ç»§ç»­
6. æ²¡æœ‰ `hours_ago` æ—¶ï¼Œåªå–ç¬¬ä¸€é¡µ

**è¿”å›**ï¼š`filtered[:tweets_per_user]`ï¼ˆé»˜è®¤ 20 æ¡ï¼‰+ API è°ƒç”¨æ¬¡æ•°

### 1.4 å»é‡é€»è¾‘

**é…ç½®**: `advanced.deduplicate`ï¼ˆé»˜è®¤ trueï¼‰

| æ–¹æ³• | é€»è¾‘ |
|------|------|
| `get_tweet_hash(id)` | `MD5(str(tweet_id)).hexdigest()` |
| `is_tweet_seen(id)` | æ£€æŸ¥ hash æ˜¯å¦åœ¨ `state["seen_tweets"]` é›†åˆä¸­ |
| `mark_tweet_seen(id)` | å°† hash æ·»åŠ åˆ°é›†åˆ |

**State æ–‡ä»¶**ï¼ˆ`advanced.state_file`ï¼Œé»˜è®¤ `.twitter_watchdog_state.json`ï¼‰ï¼š
```json
{
  "seen_tweets": ["hash1", "hash2", ...],
  "followings_cache": [...],
  "followings_updated": "2026-02-13T15:00:00+08:00"
}
```
- åŠ è½½æ—¶ï¼š`seen_tweets` ä» list è½¬ä¸º set
- ä¿å­˜æ—¶ï¼š`seen_tweets` ä» set è½¬ä¸º list

**é‡è¦**ï¼šåªæœ‰æ–°æ¨æ–‡ï¼ˆæœªåœ¨ state ä¸­ï¼‰æ‰ä¼šè¢«ä¿å­˜åˆ° raw JSONã€‚è¿™æ„å‘³ç€åŒä¸€æ¡æ¨æ–‡ä¸ä¼šåœ¨å¤šæ¬¡æŠ“å–ä¸­é‡å¤å‡ºç°ã€‚

### 1.5 çƒ­é—¨ AI æœç´¢

**æ–¹æ³•**: `search_trending_ai(max_tweets)` (lines 505-550)

**æŸ¥è¯¢æ¥æºä¼˜å…ˆçº§**ï¼š
1. `trending_search.queries`ï¼ˆåˆ—è¡¨ï¼Œæ–°æ ¼å¼ï¼‰
2. `trending_search.query`ï¼ˆå­—ç¬¦ä¸²ï¼Œæ—§æ ¼å¼ï¼ŒåŒ…è£…ä¸ºå•å…ƒç´ åˆ—è¡¨ï¼‰
3. å†…ç½®é»˜è®¤ 6 ç»„æŸ¥è¯¢

**é»˜è®¤ 6 ç»„æŸ¥è¯¢**ï¼š

| ç»„åˆ« | æŸ¥è¯¢ | min_faves |
|------|------|-----------|
| é€šç”¨ AI | `(AI OR artificial intelligence OR AGI OR ASI) min_faves:100 -is:retweet -is:reply` | 100 |
| æ¨¡å‹/äº§å“ | `(LLM OR GPT OR ChatGPT OR Claude OR Gemini OR DeepSeek OR Grok) min_faves:100 -is:retweet -is:reply` | 100 |
| å…¬å¸ | `(OpenAI OR Anthropic OR DeepMind OR Mistral) min_faves:100 -is:retweet -is:reply` | 100 |
| å¼€å‘å·¥å…· | `(AI agent OR MCP OR cursor OR copilot OR "vibe coding") min_faves:50 -is:retweet -is:reply` | 50 |
| æŠ€æœ¯æ¦‚å¿µ | `(transformer OR diffusion OR fine-tuning OR RAG OR prompt engineering) min_faves:50 -is:retweet -is:reply` | 50 |
| ä¸­æ–‡ | `(å¤§æ¨¡å‹ OR äººå·¥æ™ºèƒ½ OR æœºå™¨å­¦ä¹  OR æ·±åº¦å­¦ä¹ ) min_faves:30 -is:retweet -is:reply` | 30 |

**æ¯ç»„æ‰§è¡Œä¸¤æ¬¡æœç´¢**ï¼š

```
GET https://api.twitterapi.io/twitter/tweet/advanced_search
Params: query=<query>, queryType="Top"

GET https://api.twitterapi.io/twitter/tweet/advanced_search
Params: query=<query>, queryType="Latest"
```

- å…± 6 Ã— 2 = 12 æ¬¡ API è°ƒç”¨
- è·¨ç»„æŒ‰ tweet ID å»é‡
- æ‰“å°ï¼š`"ç»„N/M Top: +K æ¡"` / `"ç»„N/M Latest: +K æ¡"`

**åå¤„ç†**ï¼š
1. æŒ‰ `viewCount` è¿‡æ»¤ï¼š`viewCount >= min_views`ï¼ˆé»˜è®¤ 1000ï¼‰
2. æŒ‰ `viewCount` é™åºæ’åº
3. å–å‰ `max_tweets`ï¼ˆé»˜è®¤ 50ï¼‰æ¡

**ä¸å…³æ³¨åˆ—è¡¨äº¤å‰å»é‡**ï¼šå·²åœ¨å…³æ³¨åˆ—è¡¨æ¨æ–‡ä¸­å‡ºç°çš„ ID ä»çƒ­é—¨ç»“æœä¸­ç§»é™¤ã€‚

### 1.6 Raw JSON è¾“å‡º

**ç›®å½•**: `<output.directory>/raw/`
**æ–‡ä»¶å**: `YYYYMMDD_HHMMSS.json`

```json
{
  "metadata": {
    "scraped_at": "2026-02-13T15:31:45+08:00",
    "username": "rollingrock_1",
    "hours_ago": 8,
    "followings_count": 103,
    "total_tweets": 102,
    "api_calls": 111
  },
  "followings": [
    {
      "user": {
        "username": "karpathy",
        "name": "Andrej Karpathy",
        "description": "...",
        "public_metrics": {"followers_count": 999000}
      },
      "tweets": [
        {
          "id": "1234567890",
          "text": "...",
          "createdAt": "Thu Feb 13 06:00:00 +0000 2026",
          "author": {"userName": "karpathy", "name": "..."},
          "likeCount": 500,
          "retweetCount": 100,
          "viewCount": 50000,
          "url": "https://x.com/karpathy/status/1234567890",
          "isReply": false,
          "type": "tweet",
          "quotedTweet": null,
          "extendedEntities": {"media": [...]},
          "lang": "en"
        }
      ]
    }
  ],
  "trending": [
    // åŒä¸Š tweet ç»“æ„
  ]
}
```

---

## 2. Layer 2: AI åˆ†æ (Analyze)

**å…¥å£**: `run_analyze()` (twitter_watchdog.py:1317-1477)

### 2.1 å®šä½ Raw æ–‡ä»¶

**æ–¹æ³•**: `_find_raw_files()` (lines 1277-1315)

| æ¨¡å¼ | é€»è¾‘ |
|------|------|
| `--source <è·¯å¾„>` | ç›´æ¥ä½¿ç”¨æŒ‡å®šæ–‡ä»¶ï¼Œç›¸å¯¹è·¯å¾„åŸºäº `output.directory` |
| `--from / --to` | æ‰«æ `raw/*.json`ï¼ŒæŒ‰æ–‡ä»¶åæ—¶é—´æˆ³ç­›é€‰èŒƒå›´å†…çš„æ–‡ä»¶ |
| é»˜è®¤ | å– `raw/` ç›®å½•ä¸­æœ€æ–°çš„ä¸€ä¸ªæ–‡ä»¶ |

å¤šæ–‡ä»¶åœºæ™¯ï¼šæ‰€æœ‰ `followings` æ•°ç»„æ‹¼æ¥ï¼Œæ‰€æœ‰ `trending` æ•°ç»„æ‹¼æ¥ã€‚

### 2.2 æ—¶é—´çª—å£è¿‡æ»¤

**ä½ç½®**: lines 1349-1353

- å¦‚æœä¼ äº† `--from`/`--to`ï¼šä½¿ç”¨æŒ‡å®šèŒƒå›´
- å¦åˆ™å¦‚æœ `hours_ago` æœ‰å€¼ï¼š`window_from = now - hours_ago`, `window_to = now`

**æ¨æ–‡æ—¶é—´è§£æ** (`parse_tweet_time()`ï¼Œlines 148-165)ï¼š
- é¦–å…ˆå°è¯•ï¼š`"%a %b %d %H:%M:%S %z %Y"`ï¼ˆTwitter åŸç”Ÿæ ¼å¼ï¼‰
- å¤±è´¥åˆ™å°è¯•ï¼š`fromisoformat()`
- è½¬æ¢åˆ° UTC+8 æ—¶åŒº

æ¯æ¡æ¨æ–‡çš„ `createdAt` å¿…é¡»åœ¨ `[window_from, window_to]` èŒƒå›´å†…æ‰ä¿ç•™ã€‚

### 2.3 å…³é”®è¯é¢„è¿‡æ»¤

**æ–¹æ³•**: `filter_tweet(tweet)` (lines 554-586)

**å®Œæ•´åˆ¤å®šæµç¨‹**ï¼ˆæŒ‰é¡ºåºæ‰§è¡Œï¼Œå‘½ä¸­å³è¿”å›ï¼‰ï¼š

```
1. filters.enabled == false?
   â†’ è¿”å› (True, "no_filters")  // ä¸è¿‡æ»¤

2. filters.language != "all" ä¸” tweet.lang != language?
   â†’ è¿”å› (False, "language_filter")  // è¯­è¨€ä¸åŒ¹é…

3. tweet.likeCount < filters.min_likes?
   â†’ è¿”å› (False, "engagement_filter")  // ç‚¹èµä¸å¤Ÿ

4. tweet.retweetCount < filters.min_retweets?
   â†’ è¿”å› (False, "engagement_filter")  // è½¬å‘ä¸å¤Ÿ

5. ai_summary.ai_filter == true?
   â†’ è¿”å› (True, "ai_filter_mode")  // è·³è¿‡å…³é”®è¯ï¼Œäº¤ç»™ Claude åˆ¤æ–­

6. ä»»ä½• exclude å…³é”®è¯åŒ¹é…ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰?
   â†’ è¿”å› (False, "excluded_keyword:<kw>")

7. include åˆ—è¡¨éç©º ä¸” æ²¡æœ‰ä»»ä½• include å…³é”®è¯åŒ¹é…?
   â†’ è¿”å› (False, "no_include_keyword")

8. é€šè¿‡æ‰€æœ‰æ£€æŸ¥
   â†’ è¿”å› (True, "passed")
```

**å…³é”®**ï¼šå½“ `ai_filter=true`ï¼ˆé»˜è®¤ï¼‰æ—¶ï¼Œæ­¥éª¤ 5 ç›´æ¥æ”¾è¡Œï¼Œå…³é”®è¯è¿‡æ»¤å®Œå…¨ä¸ç”Ÿæ•ˆã€‚æ‰€æœ‰æ¨æ–‡ç›´æ¥é€ç»™ Claude åˆ¤æ–­ã€‚

### 2.4 å›¾ç‰‡æ”¶é›†

**æ–¹æ³•**: `collect_tweet_image(tweet)` (lines 433-445)

- æ£€æŸ¥ `extendedEntities.media`ã€`entities.media`ã€`media` ä¸‰ä¸ªä½ç½®
- åŒ¹é…åŒ…å« `.jpg`ã€`.png`ã€`.jpeg`ã€`.gif`ã€`.webp` çš„ URL
- å¦‚æœç›´æ¥æ¨æ–‡æ— åª’ä½“ï¼Œæ£€æŸ¥å¼•ç”¨æ¨æ–‡çš„åª’ä½“
- å­˜å‚¨ï¼š`self.tweet_images[tweet_url] = image_url`

### 2.5 AI ç­›é€‰ (Pass 1)

**æ ¸å¿ƒæ–¹æ³•**: `_filter_and_summarize()` (lines 855-904)

#### æ„å»ºæ¨æ–‡è¡Œ

**æ ¼å¼**ï¼ˆ`_build_tweet_lines`ï¼Œlines 821-853ï¼‰ï¼š

```
## å…³æ³¨åˆ—è¡¨æ¨æ–‡ï¼š
- [ID:1234567890] @karpathy (50000 views, 500 likes): This is the tweet text truncated to 200 chars...
  [å¼•ç”¨ @openai]: Quoted tweet text truncated to 150 chars...
  URL: https://x.com/karpathy/status/1234567890

## å…¨ç½‘çƒ­é—¨ AI æ¨æ–‡ï¼š
- [ID:9876543210] @elonmusk (100000 views, 2000 likes): Another tweet...
  URL: https://x.com/elonmusk/status/9876543210
```

`[ID:<tid>]` å‰ç¼€ä»…åœ¨ç­›é€‰é˜¶æ®µå‡ºç°ï¼Œæ€»ç»“é˜¶æ®µä¸åŒ…å«ã€‚

#### æ‰¹é‡åˆ†å‰²

**æ–¹æ³•**: `_batch_lines_by_tokens()` (lines 773-788)

- Token ä¼°ç®—ï¼š**0.4 tokens/å­—ç¬¦**
- é¢„ç®—ï¼š`max_input_tokens - 2000`ï¼ˆé»˜è®¤ 148,000 tokensï¼‰
- é€è¡Œç´¯åŠ ï¼Œè¶…å‡ºé¢„ç®—åˆ™å¼€æ–°æ‰¹æ¬¡

#### ç­›é€‰ Promptï¼ˆé€å­—å¤åˆ¶ï¼‰

```
ä½ æ˜¯ä¸€ä¸ª AI è¡Œä¸šä¿¡æ¯ç­›é€‰å‘˜ã€‚ä»¥ä¸‹æ˜¯ä» Twitter æŠ“å–çš„æ¨æ–‡åˆ—è¡¨{window_desc}ã€‚

ä»»åŠ¡ï¼š
1. ä»ä¸­æ‰¾å‡ºæ‰€æœ‰ä¸ AI é¢†åŸŸç›¸å…³çš„æ¨æ–‡ï¼ˆåŒ…æ‹¬ AI äº§å“ã€æ¨¡å‹ã€å¼€å‘å·¥å…·ã€è¡Œä¸šåŠ¨æ€ã€ç ”ç©¶ç­‰ï¼‰ã€‚
2. åœ¨ AI ç›¸å…³æ¨æ–‡ä¸­ï¼Œæ ‡å‡ºç´§æ€¥ç¨‹åº¦ä¸º"çªå‘"çš„æ¨æ–‡ï¼ˆé‡å¤§äº§å“å‘å¸ƒã€é‡å¤§æ”¶è´­ã€å®‰å…¨äº‹ä»¶ç­‰éœ€è¦ç«‹å³å…³æ³¨çš„ï¼‰ã€‚

åªè¾“å‡º JSONï¼Œä¸è¦è¾“å‡ºå…¶ä»–å†…å®¹ï¼š
```json
{"ai_tweet_ids": ["id1", "id2", ...], "urgent_ids": ["id3", ...]}
```

urgent_ids å¿…é¡»æ˜¯ ai_tweet_ids çš„å­é›†ï¼ŒåªåŒ…å«çœŸæ­£é‡å¤§çš„çªå‘äº‹ä»¶ï¼ˆæ¯æ‰¹é€šå¸¸ 0-2 æ¡ï¼‰ã€‚

---
{batch_content}
```

#### å“åº”è§£æ

- `_parse_ai_tweet_ids()`ï¼šå…ˆæ‰¾ ` ```json...``` ` ä»£ç å—ï¼Œå†æ‰¾ `{"ai_tweet_ids": ...}` å­—ç¬¦ä¸²
- `_parse_urgent_ids()`ï¼šåŒæ ·ç­–ç•¥ï¼Œæ‰¾ `"urgent_ids"` é”®
- `urgent_ids` å­˜å‚¨åœ¨ `self._urgent_ids` ä¸Š

#### é‡è¯•ç­–ç•¥

**æ–¹æ³•**: `_filter_batch_robust()` (lines 906-945)

å¤±è´¥æ—¶ï¼š
- å¦‚æœæ‰¹æ¬¡ > 10 è¡Œï¼š**äºŒåˆ†æ‹†åˆ†**ï¼Œå‰åŠå’ŒååŠå„è‡ªé€’å½’é‡è¯•
- å¦‚æœæ‰¹æ¬¡ â‰¤ 10 è¡Œï¼šæ”¾å¼ƒï¼Œè¿”å›ç©ºé›†åˆ
- æ·±åº¦è¿½è¸ªç”¨äºæ—¥å¿—ç¼©è¿›

### 2.6 AI æ€»ç»“ (Pass 2)

**æ–¹æ³•**: `_batched_summarize_from_lines()` (lines 993-1068)

ç­›é€‰é€šè¿‡çš„æ¨æ–‡ï¼ˆ`ai_tweet_ids` ä¸­çš„ï¼‰é‡æ–°æ„å»ºæ¨æ–‡è¡Œï¼ˆä¸å¸¦ `[ID:]` å‰ç¼€ï¼‰ï¼Œåˆ†æ‰¹é€ç»™ Claude æ€»ç»“ã€‚

#### æ€»ç»“ Promptï¼ˆé€å­—å¤åˆ¶ï¼‰

```
ä½ æ˜¯ä¸€ä¸ª AI è¡Œä¸šä¿¡æ¯æ•´ç†å‘˜ã€‚ä»¥ä¸‹æ˜¯ä» Twitter æŠ“å–çš„ AI ç›¸å…³æ¨æ–‡{window_desc}{batch_label}ã€‚

ä»»åŠ¡ï¼šç”Ÿæˆç»“æ„åŒ–çš„åˆ†ç±»æ—¥æŠ¥ã€‚

è¯»è€…ç”»åƒï¼šå…³æ³¨ AI å‰æ²¿åŠ¨æ€çš„ä»ä¸šè€…ã€‚ä»–ä»¬æƒ³ä»æ¯æ¡æ–°é—»ä¸­å¿«é€Ÿäº†è§£ï¼šå‘ç”Ÿäº†ä»€ä¹ˆã€è°å‘å¸ƒçš„ã€æ ¸å¿ƒå†…å®¹ï¼ˆåŠŸèƒ½/æŒ‡æ ‡/æ•°æ®/ä»·æ ¼ï¼‰ã€æ€ä¹ˆè·å–æˆ–æœ‰ä»€ä¹ˆæ„ä¹‰ã€‚

{category_block}

{rules_block}

---
{batch_content}
```

#### ä¸‰ç§é£æ ¼æ¨¡æ¿

**`_build_style_prompts(style, custom_prompt)`ï¼Œlines 590-674**

æ‰€æœ‰é£æ ¼å…±äº«ç›¸åŒçš„åˆ†ç±»ç»“æ„ï¼ˆ`category_block`ï¼‰ï¼š

```
## æœ¬æœŸè¦ç‚¹
ç”¨ 3~5 ä¸ª bullet point æ¦‚æ‹¬æœ€é‡è¦çš„äº‹ä»¶/å‘å¸ƒ/è¶‹åŠ¿ï¼Œæ¯æ¡ä¸€å¥è¯ï¼Œä¸å¸¦é“¾æ¥ã€‚

## AI äº§å“ä¸å·¥å…·
## AI æ¨¡å‹ä¸æŠ€æœ¯
## AI å¼€å‘è€…ç”Ÿæ€
## AI è¡Œä¸šåŠ¨æ€
## AI ç ”ç©¶ä¸è§‚ç‚¹
```

**ç²¾ç®€ (concise)**ï¼š
```
æ¯ä¸ªåˆ†ç±»ä¸‹çš„æ¡ç›®æ ¼å¼ï¼š
- [å…·ä½“æ ‡é¢˜](æ¨æ–‡URL)ã€‚ä¸€å¥è¯æ ¸å¿ƒäº‹å®ã€‚

è§„åˆ™ï¼š
- æ¯æ¡æè¿°ä¸è¶…è¿‡ 30 å­—
- åˆå¹¶æŠ¥é“åŒä¸€äº‹ä»¶çš„ä¸åŒæ¨æ–‡
- æ¯ä¸ªåˆ†ç±»å†…æŒ‰é‡è¦æ€§ä»é«˜åˆ°ä½æ’åˆ—
- å¦‚æœæŸä¸ªåˆ†ç±»ä¸‹æ²¡æœ‰å†…å®¹ï¼Œçœç•¥è¯¥åˆ†ç±»
- ä¸è¦åŠ å‰è¨€æˆ–ç»“å°¾æ€»ç»“æ®µè½
- ç›´æ¥è¾“å‡ºæœ€ç»ˆç‰ˆæœ¬
```

**æ ‡å‡† (standard)**ï¼š
```
æ¯ä¸ªåˆ†ç±»ä¸‹çš„æ¡ç›®æ ¼å¼ï¼š
- [å…·ä½“æ ‡é¢˜](æ¨æ–‡URL)ã€‚é™ˆè¿°å¥æè¿°ï¼Œä¿¡æ¯å¯†åº¦é«˜ã€‚

è§„åˆ™ï¼š
- æ ‡é¢˜åº”å½“æ˜¯"å…·ä½“çš„"æè¿°ï¼Œè€Œä¸æ˜¯"æŸæŸå‘æ¨è¯´..."
- æè¿°åº”ä¸º 1-2 å¥è‡ªç„¶è¯­è¨€æ¦‚è¿°ï¼ŒåŒ…å«æ ¸å¿ƒè¦ç‚¹
- å¦‚æœæ¨æ–‡ä¸­æœ‰æ•°æ®ï¼ˆæ€§èƒ½æŒ‡æ ‡ã€ä»·æ ¼ã€ç”¨æˆ·æ•°ç­‰ï¼‰ï¼Œå¿…é¡»åŒ…å«
- å¦‚æœæ¨æ–‡å¼•ç”¨æˆ–è½¬å‘äº†å…¶ä»–å†…å®¹ï¼Œæè¿°åº”æ¶µç›–è¢«å¼•ç”¨å†…å®¹çš„æ ¸å¿ƒä¿¡æ¯
- åˆå¹¶æŠ¥é“åŒä¸€äº‹ä»¶çš„ä¸åŒæ¨æ–‡ï¼Œç»¼åˆå¤šä¸ªä¿¡æ¯æº
- æ¯ä¸ªåˆ†ç±»å†…æŒ‰é‡è¦æ€§ä»é«˜åˆ°ä½æ’åˆ—
- å¦‚æœæŸä¸ªåˆ†ç±»ä¸‹æ²¡æœ‰å†…å®¹ï¼Œçœç•¥è¯¥åˆ†ç±»
- ä¸è¦åŠ å‰è¨€æˆ–ç»“å°¾æ€»ç»“æ®µè½
- ç›´æ¥è¾“å‡ºæœ€ç»ˆç‰ˆæœ¬
```

**è¯¦ç»† (advanced)**ï¼š
```
æ¯ä¸ªåˆ†ç±»ä¸‹çš„æ¡ç›®æ ¼å¼ï¼š
- [å…·ä½“æ ‡é¢˜](æ¨æ–‡URL)ã€‚å®¢è§‚æè¿°ï¼Œä¿¡æ¯é½å…¨ä½†ä¸å†—ä½™ã€‚
  **ä¸ºä»€ä¹ˆé‡è¦**ï¼šåˆ†æè¿™æ¡ä¿¡æ¯å¯¹ AI è¡Œä¸š/å¼€å‘è€…/ç”¨æˆ·çš„å½±å“å’Œæ„ä¹‰ã€‚

è§„åˆ™ï¼š
- æ¯æ¡å¿…é¡»åŒ…å«"ä¸ºä»€ä¹ˆé‡è¦"åˆ†æï¼ˆ1-2 å¥è¯ï¼‰
- æ ‡é¢˜åº”å½“æ˜¯"å…·ä½“çš„"æè¿°
- æè¿°åŒ…å«æ•°æ®ã€æ ¸å¿ƒåŠŸèƒ½ã€å…·ä½“ç‰¹ç‚¹
- å¦‚æœæ¨æ–‡æåˆ°å¯ä»¥ä½“éªŒçš„å·¥å…·/äº§å“ï¼Œè¯´æ˜å¦‚ä½•è·å–
- åˆå¹¶æŠ¥é“åŒä¸€äº‹ä»¶çš„ä¸åŒæ¨æ–‡
- æ¯ä¸ªåˆ†ç±»å†…æŒ‰é‡è¦æ€§ä»é«˜åˆ°ä½æ’åˆ—
- å¦‚æœæŸä¸ªåˆ†ç±»ä¸‹æ²¡æœ‰å†…å®¹ï¼Œçœç•¥è¯¥åˆ†ç±»
- ä¸è¦åŠ å‰è¨€æˆ–ç»“å°¾æ€»ç»“æ®µè½
```

**è‡ªå®šä¹‰æç¤ºè¯æ³¨å…¥**ï¼š
å¦‚æœ `custom_prompt` éç©ºï¼Œè¿½åŠ åˆ° `rules_block` æœ«å°¾ï¼š
```
ç”¨æˆ·ç‰¹åˆ«è¦æ±‚ï¼š
{custom_prompt}
```

#### å¤šæ‰¹æ¬¡åˆå¹¶

å¦‚æœåˆ†æ‰¹äº§ç”Ÿäº†å¤šä¸ªæ€»ç»“ï¼Œé€šè¿‡ Claude åˆå¹¶ï¼š

```
ä½ æ˜¯ä¸€ä¸ª AI è¡Œä¸šä¿¡æ¯è´¨é‡å®¡æ ¸å‘˜ã€‚ä»¥ä¸‹æ˜¯åˆ†æ‰¹å¤„ç†äº§ç”Ÿçš„å¤šä»½ AI æ¨æ–‡æ€»ç»“ï¼Œè¯·åˆå¹¶ä¸ºä¸€ä»½é«˜ç½®ä¿¡åº¦çš„æœ€ç»ˆæ—¥æŠ¥ã€‚

ä»»åŠ¡ï¼š
1. åˆå¹¶æŠ¥é“åŒä¸€äº‹ä»¶çš„ä¸åŒæ¡ç›®ï¼ˆä¿ç•™æœ€å®Œæ•´çš„æè¿°ï¼Œç»¼åˆå¤šä¸ªä¿¡æ¯æºï¼‰
2. å»é™¤å®Œå…¨é‡å¤çš„æ¡ç›®
3. æ£€æŸ¥é«˜åº¦ç›¸ä¼¼çš„æ¡ç›®ï¼ˆåŒä¸€äº§å“/äº‹ä»¶çš„ä¸åŒè§’åº¦ï¼‰ï¼Œåˆå¹¶ä¸ºä¸€æ¡ç»¼åˆæè¿°
4. ç¡®ä¿æ¯æ¡éƒ½ä¿ç•™äº†æœ‰æ•ˆçš„æ¨æ–‡ URLï¼ˆæ ¼å¼ï¼š[æ ‡é¢˜](URL)ï¼‰
5. ç¡®ä¿åˆ†ç±»å‡†ç¡®ï¼Œæ¯ä¸ªåˆ†ç±»å†…æŒ‰é‡è¦æ€§æ’åˆ—
6. ä¿æŒæ ¼å¼ä¸€è‡´ï¼š- [æ ‡é¢˜](URL)ã€‚æè¿°ã€‚

è§„åˆ™ï¼š
- ä¿æŒåŸæœ‰çš„åˆ†ç±»ç»“æ„ï¼ˆæœ¬æœŸè¦ç‚¹ã€AI äº§å“ä¸å·¥å…·ã€AI æ¨¡å‹ä¸æŠ€æœ¯ç­‰ï¼‰
- å¦‚æœæŸä¸ªåˆ†ç±»ä¸‹æ²¡æœ‰å†…å®¹ï¼Œçœç•¥è¯¥åˆ†ç±»
- ä¸è¦åŠ å‰è¨€æˆ–ç»“å°¾æ€»ç»“æ®µè½
- ç›´æ¥è¾“å‡ºæœ€ç»ˆç‰ˆæœ¬

### æ‰¹æ¬¡ 1 æ€»ç»“ï¼š
<summary1>

---

### æ‰¹æ¬¡ 2 æ€»ç»“ï¼š
<summary2>
```

#### å•æ‰¹æ¬¡æ ¡éªŒ

**æ–¹æ³•**: `_validate_summary()` (lines 1109-1139)

```
ä½ æ˜¯ä¸€ä¸ª AI ä¿¡æ¯è´¨é‡å®¡æ ¸å‘˜ã€‚ä»¥ä¸‹æ˜¯ä¸€ä»½ AI æ¨æ–‡æ—¥æŠ¥ï¼Œè¯·è¿›è¡Œæœ€ç»ˆæ ¡éªŒå’Œä¼˜åŒ–ã€‚

æ ¡éªŒä»»åŠ¡ï¼š
1. é‡å¤æ£€æµ‹ï¼šæ‰¾å‡ºæè¿°åŒä¸€äº‹ä»¶/æ–°é—»çš„é‡å¤æ¡ç›®ï¼Œåªä¿ç•™ä¿¡æ¯æœ€å®Œæ•´çš„ä¸€æ¡
2. ç›¸ä¼¼åˆå¹¶ï¼šå°†é«˜åº¦ç›¸å…³çš„æ¡ç›®ï¼ˆåŒä¸€äº§å“/äº‹ä»¶çš„ä¸åŒè§’åº¦ï¼‰åˆå¹¶ä¸ºä¸€æ¡ç»¼åˆæè¿°
3. URL æ£€æŸ¥ï¼šç¡®ä¿æ¯æ¡éƒ½åŒ…å«æœ‰æ•ˆçš„æ¨æ–‡é“¾æ¥ï¼Œæ ¼å¼ä¸º [æ ‡é¢˜](URL)
4. åˆ†ç±»æ ¡éªŒï¼šç¡®è®¤æ¡ç›®æ”¾åœ¨äº†æ­£ç¡®çš„åˆ†ç±»ä¸‹ï¼Œå¦‚æœ‰é”™è¯¯åˆ™è°ƒæ•´
5. æ ¼å¼ç»Ÿä¸€ï¼šæ¯æ¡æ ¼å¼ä¸º - [æ ‡é¢˜](URL)ã€‚æè¿°ã€‚

è§„åˆ™ï¼š
- å¦‚æœå†…å®¹å·²ç»å¾ˆå¥½ï¼Œæ— éœ€é‡å¤/åˆå¹¶é—®é¢˜ï¼Œç›´æ¥åŸæ ·è¾“å‡º
- å¦‚æœæœ‰éœ€è¦ä¿®æ­£çš„ï¼Œè¾“å‡ºä¿®æ­£åçš„å®Œæ•´ç‰ˆæœ¬
- ä¿æŒåŸæœ‰åˆ†ç±»ç»“æ„
- ä¸è¦åŠ ä»»ä½•è¯´æ˜ã€æ³¨é‡Šã€å‰è¨€æˆ–ç»“å°¾
- ç›´æ¥è¾“å‡ºæœ€ç»ˆç‰ˆæœ¬

---
{summary_text}
```

å¤±è´¥æ—¶è¿”å›åŸå§‹æ€»ç»“ï¼Œä¸ä¸­æ–­æµç¨‹ã€‚

### 2.7 Claude API è°ƒç”¨ç»†èŠ‚

**æ–¹æ³•**: `_call_claude_api()` (lines 745-771)

```
POST <base_url>/v1/messages
Headers:
  x-api-key: <api_key>
  anthropic-version: 2023-06-01
  content-type: application/json
Body:
  model: <model>
  max_tokens: <max_tokens>
  messages: [{"role": "user", "content": "<prompt>"}]
```

**é‡è¯•ç­–ç•¥**ï¼š
- æœ€å¤š 3 æ¬¡é‡è¯•
- ç­‰å¾…æ—¶é—´ï¼š`10 Ã— attempt` ç§’ï¼ˆç¬¬ 1 æ¬¡ç­‰ 10sï¼Œç¬¬ 2 æ¬¡ç­‰ 20sï¼‰
- è¶…æ—¶é€’å¢ï¼š`timeout Ã— 1.5`ï¼ˆ120 â†’ 180 â†’ 270 ç§’ï¼‰
- è¿”å›ï¼š`(response_text, {"input": input_tokens, "output": output_tokens})`

### 2.8 Analysis JSON è¾“å‡º

**ç›®å½•**: `<output.directory>/analysis/`
**æ–‡ä»¶å**: `YYYYMMDD_HHMMSS.json`

```json
{
  "metadata": {
    "analyzed_at": "2026-02-13T15:41:46+08:00",
    "source_files": ["20260213_153145.json"],
    "time_window": {
      "from": "2026-02-13T11:41:00+08:00",
      "to": "2026-02-13T15:41:00+08:00"
    },
    "total_tweets": 102,
    "filtered_count": 21,
    "model": "claude-sonnet-4-5-20250929"
  },
  "ai_tweet_ids": ["id1", "id2", "..."],
  "urgent_ids": ["id3"],
  "summary": "# AI æ¨æ–‡æ—¥æŠ¥\n\n## æœ¬æœŸè¦ç‚¹\n...",
  "filtered_followings": [
    {
      "user": {"username": "...", ...},
      "tweets": [/* åªåŒ…å« AI ç›¸å…³çš„æ¨æ–‡ */]
    }
  ],
  "filtered_trending": [/* åªåŒ…å« AI ç›¸å…³çš„çƒ­é—¨æ¨æ–‡ */]
}
```

---

## 3. Layer 3: æŠ¥å‘Šç”Ÿæˆ (Report)

**å…¥å£**: `run_report()` (twitter_watchdog.py:1528-1655)

### 3.1 å®šä½ Analysis æ–‡ä»¶

**æ–¹æ³•**: `_find_analysis_files()` (lines 1481-1526)

| æ¨¡å¼ | é€»è¾‘ |
|------|------|
| `--source <è·¯å¾„>` | ç›´æ¥ä½¿ç”¨æŒ‡å®šæ–‡ä»¶ |
| `--daily YYYY-MM-DD` | æ‰€æœ‰æ–‡ä»¶åä»¥ `YYYYMMDD` å¼€å¤´çš„ analysis æ–‡ä»¶ |
| `--weekly YYYY-MM-DD` | æ–‡ä»¶åæ—¥æœŸåœ¨èµ·å§‹æ—¥ 7 å¤©å†…çš„æ‰€æœ‰æ–‡ä»¶ |
| `--monthly YYYY-MM` | æ–‡ä»¶åä»¥ `YYYYMM` å¼€å¤´çš„æ‰€æœ‰æ–‡ä»¶ |
| é»˜è®¤ | æœ€æ–°çš„ä¸€ä¸ª analysis æ–‡ä»¶ |

### 3.2 æŠ¥å‘Šèšåˆé€»è¾‘

**å•æ–‡ä»¶ï¼ˆéå‘¨æœŸæŠ¥å‘Šï¼‰**ï¼šç›´æ¥ä½¿ç”¨ summary æ–‡æœ¬ã€‚

**å¤šæ–‡ä»¶ï¼ˆå‘¨æœŸæŠ¥å‘Šï¼‰**ï¼š

1. **è§£ææ¡ç›®** (`_parse_summary_items()`ï¼Œlines 2302-2320)ï¼š
   - æ­£åˆ™åŒ¹é…ï¼š`^- \[(.+?)\]\((.+?)\)[ï¼Œã€‚,.]\s*(.+)$`
   - æå–ï¼š`title`ã€`url`ã€`description`ã€`full_text`

2. **æŒ‰ URL å»é‡** (`_deduplicate_items()`ï¼Œlines 2322-2329)ï¼š
   - åŒä¸€ URL ä¿ç•™ `full_text` æœ€é•¿çš„æ¡ç›®

3. **Claude æ•´åˆ** (`_claude_consolidate()`ï¼Œlines 2331-2426)ï¼š

```
ä½ æ˜¯ä¸€ä¸ª AI è¡Œä¸šä¿¡æ¯æ•´ç†å‘˜ã€‚ä»¥ä¸‹æ˜¯ {period_label} æœŸé—´æ¯æ—¥ AI æ¨æ–‡æ€»ç»“ä¸­æ±‡æ€»çš„ä¿¡æ¯æ¡ç›®ï¼ˆå·²æŒ‰ URL åˆæ­¥å»é‡ï¼Œå…± {N} æ¡ï¼‰ã€‚

ä»»åŠ¡ï¼šå°†è¿™äº›æ¡ç›®æ•´åˆä¸ºä¸€ä»½ç»“æ„åŒ–çš„{label}ã€‚

è¾“å‡ºç»“æ„ï¼ˆä¸¥æ ¼éµå¾ªï¼‰ï¼š

## æœ¬æœŸè¦ç‚¹
ç”¨ 3~5 ä¸ª bullet point æ¦‚æ‹¬æœ¬æœŸæœ€é‡è¦çš„äº‹ä»¶/å‘å¸ƒ/è¶‹åŠ¿ï¼Œæ¯æ¡ä¸€å¥è¯ï¼Œä¸å¸¦é“¾æ¥ã€‚

## AI äº§å“ä¸å·¥å…·
## AI æ¨¡å‹ä¸æŠ€æœ¯
## AI å¼€å‘è€…ç”Ÿæ€
## AI è¡Œä¸šåŠ¨æ€
## AI ç ”ç©¶ä¸è§‚ç‚¹

æ¯ä¸ªåˆ†ç±»ä¸‹çš„æ¡ç›®æ ¼å¼ï¼š
- [å…·ä½“æ ‡é¢˜](æ¨æ–‡URL)ã€‚å®¢è§‚æè¿°ï¼Œä¿¡æ¯é½å…¨ä½†ä¸å†—ä½™ã€‚

è§„åˆ™ï¼š
- åˆå¹¶æŠ¥é“åŒä¸€äº‹ä»¶/äº§å“çš„ä¸åŒæ¡ç›®ï¼Œä¿ç•™æœ€å®Œæ•´çš„æè¿°
- æ¯ä¸ªåˆ†ç±»å†…æŒ‰é‡è¦æ€§ä»é«˜åˆ°ä½æ’åˆ—
- æ¯æ¡æè¿°åº”åŒ…å«å…³é”®æ•°æ®ã€æ ¸å¿ƒåŠŸèƒ½ã€å…·ä½“ç‰¹ç‚¹ï¼Œå»é™¤é‡å¤ä¿®é¥°å’Œç©ºæ³›è¡¨è¿°
- åªæè¿°å®¢è§‚äº‹å®ï¼Œä¸åšä¸»è§‚è¯„ä»·
- å¦‚æœæŸä¸ªåˆ†ç±»ä¸‹æ²¡æœ‰å†…å®¹ï¼Œçœç•¥è¯¥åˆ†ç±»
- ä¸è¦åŠ ç»Ÿè®¡æ•°æ®æˆ–ç»“å°¾æ€»ç»“

---
{content}
```

- æœˆæŠ¥çš„ `max_tokens` è‡³å°‘ 8192
- ç›´æ¥ `requests.post` è°ƒç”¨ï¼Œè¶…æ—¶ 180 ç§’
- å¤±è´¥æ—¶å›é€€ï¼šç›´æ¥æ‹¼æ¥æ‰€æœ‰ `full_text`

### 3.3 å›¾ç‰‡å¤„ç†

**ä¸‹è½½** (`download_report_images()`ï¼Œlines 447-476)ï¼š
- æ‰«æ summary ä¸­åŒ¹é… `\(https://x\.com/[^)]+\)` çš„ URL
- ä¸ `self.tweet_images` æ˜ å°„äº¤å‰
- ä¸‹è½½åˆ° `<reports_dir>/images/<timestamp>/`
- æ–‡ä»¶åï¼š`<tweet_id>.<ext>`

**æ’å…¥** (`insert_images_into_summary()`ï¼Œlines 479-491)ï¼š
- åœ¨åŒ…å« `](<tweet_url>)` çš„è¡Œåæ’å…¥ `![tweet](<relative_path>)`

### 3.4 HTML ç”Ÿæˆ

**æ–¹æ³•**: `save_as_html()` â†’ `_summary_md_to_html()` â†’ `_html_page()`

**Markdown â†’ HTML è½¬æ¢** (`_summary_md_to_html`ï¼Œlines 2169-2273)ï¼š
- æŒ‰ `## ` åˆ†å‰²ä¸º sections
- "æœ¬æœŸè¦ç‚¹" â†’ `highlights-card`ï¼Œå¸¦å½©è‰²æ¸å˜åœ†ç‚¹
- 5 ä¸ªåˆ†ç±»å„æœ‰é¢œè‰²æ ‡ç­¾ï¼š
  - AI äº§å“ä¸å·¥å…· â†’ è“è‰²
  - AI æ¨¡å‹ä¸æŠ€æœ¯ â†’ ç²‰è‰²
  - AI å¼€å‘è€…ç”Ÿæ€ â†’ ç»¿è‰²
  - AI è¡Œä¸šåŠ¨æ€ â†’ é»„è‰²
  - AI ç ”ç©¶ä¸è§‚ç‚¹ â†’ ç´«è‰²
- æ¯ä¸ª `- [æ ‡é¢˜](URL)ã€‚æè¿°` â†’ `news-card` å¡ç‰‡
- å›¾ç‰‡ â†’ `<img>` æ‡’åŠ è½½

**HTML æ¨¡æ¿** (`_html_page`ï¼Œlines 1834-2148)ï¼š
- è‡ªåŒ…å« HTMLï¼ˆæ‰€æœ‰ CSS å†…è”ï¼Œæ— å¤–éƒ¨ä¾èµ–ï¼‰
- ç²˜æ€§å¯¼èˆª + æ»šåŠ¨é«˜äº®
- è‡ªåŠ¨/æµ…è‰²/æ·±è‰²ä¸»é¢˜åˆ‡æ¢
- å›åˆ°é¡¶éƒ¨æŒ‰é’®ï¼ˆæ»šåŠ¨ 400px åå‡ºç°ï¼‰
- ç§»åŠ¨ç«¯å“åº”å¼ï¼ˆ640px æ–­ç‚¹ï¼‰
- æ‰“å°æ ·å¼ï¼ˆéšè—å¯¼èˆªå’Œä¸»é¢˜åˆ‡æ¢ï¼‰

### 3.5 æ–‡ä»¶å‘½å

| æ¨¡å¼ | HTML æ–‡ä»¶å | MD æ–‡ä»¶å |
|------|------------|-----------|
| æ—¥æŠ¥ | `daily_YYYYMMDD.html` | `daily_YYYYMMDD.md` |
| å‘¨æŠ¥ | `weekly_YYYYMMDD.html` | `weekly_YYYYMMDD.md` |
| æœˆæŠ¥ | `monthly_YYYYMM.html` | `monthly_YYYYMM.md` |
| é»˜è®¤ | `YYYYMMDD_HHMMSS.html` | `YYYYMMDD_HHMMSS.md` |

å§‹ç»ˆæ›´æ–° `latest.html` ä¸ºæœ€æ–°æŠ¥å‘Šçš„å‰¯æœ¬ã€‚

### 3.6 Markdown ç”Ÿæˆ

**æ–¹æ³•**: `_save_report_markdown()` (lines 1657-1705)

å†…å®¹ç»“æ„ï¼š
- å¤´éƒ¨ï¼šç”Ÿæˆæ—¶é—´ã€æ—¶é—´çª—å£ã€æ¨æ–‡æ•°é‡
- AI æ€»ç»“ï¼ˆå¦‚æœæœ‰ï¼‰
- å…³æ³¨åˆ—è¡¨è¯¦æƒ…ï¼šæ¯ä¸ªç”¨æˆ·çš„å¤´éƒ¨ä¿¡æ¯ + æ¯æ¡æ¨æ–‡çš„æ—¶é—´ã€æ­£æ–‡ã€äº’åŠ¨æ•°æ®ã€URL
- çƒ­é—¨æ¨æ–‡è¯¦æƒ…ï¼šåŒä¸Šæ ¼å¼

### 3.7 é€šçŸ¥

**macOS é€šçŸ¥** (`send_notification()`ï¼Œlines 1143-1156)ï¼š
- æ¡ä»¶ï¼š`notifications.enabled=true` ä¸” `on_new_tweets=true` ä¸”æ¨æ–‡æ•° â‰¥ `threshold`
- é€šè¿‡ `osascript` è°ƒç”¨ç³»ç»Ÿé€šçŸ¥
- å£°éŸ³ï¼š`notifications.sound`ï¼ˆé»˜è®¤ "Glass"ï¼‰

---

## 4. æµæ°´çº¿ (Pipeline)

**å…¥å£**: `run_pipeline()` (lines 1817-1830)

```python
raw_file = self.run_scrape()           # Layer 1
if not raw_file: return

analysis_file = self.run_analyze(source=raw_file)  # Layer 2
if not analysis_file: return

self.run_report(source=analysis_file)  # Layer 3
self.push_summary(source=analysis_file)  # Telegram æ¨é€
```

### Telegram æ¨é€

**`push_summary(source, test)`** (lines 1739-1783)ï¼š
- æµ‹è¯•æ¨¡å¼ï¼šå‘é€ `"Twitter Watchdog æ¨é€æµ‹è¯•æˆåŠŸï¼"`
- æ­£å¸¸æ¨¡å¼ï¼š
  1. è¯»å–æœ€æ–° analysis JSON
  2. æå– "æœ¬æœŸè¦ç‚¹" éƒ¨åˆ†ï¼ˆ`_extract_highlights()`ï¼‰
  3. æ ¼å¼åŒ–ï¼š`"AI æ–°é—»é€Ÿé€’ (MM/DD HH:MM)\n\n<highlights>"`
  4. æˆªæ–­åˆ° 4000 å­—ç¬¦ï¼ˆTelegram é™åˆ¶ 4096ï¼‰
  5. é€šè¿‡ `_telegram_send()` å‘é€

**`_telegram_send(text)`** (lines 1709-1737)ï¼š

```
POST https://api.telegram.org/bot{bot_token}/sendMessage
Body: {chat_id, text, parse_mode: "Markdown", disable_web_page_preview: true}
Proxy: push.telegram.proxyï¼ˆå¦‚æœé…ç½®äº†ï¼‰
Timeout: 15s
```

**`push_urgent(tweets)`** (lines 1786-1796)ï¼š
- é€æ¡å‘é€ç´§æ€¥æ¨æ–‡ï¼š`"ğŸ”´ çªå‘ AI æ–°é—»\n\n@author: text[:200]\n\nurl"`
- **æ³¨æ„**ï¼šè¯¥æ–¹æ³•å­˜åœ¨ä½†å½“å‰æœªè¢«ä»»ä½•åœ°æ–¹è°ƒç”¨ã€‚`urgent_ids` è¢«ä¿å­˜åˆ° analysis JSONï¼Œä½† `run_pipeline` æ²¡æœ‰è°ƒç”¨ `push_urgent`ã€‚

---

## 5. å…¨éƒ¨å¯é…ç½®å‚æ•°

### twitter_api

| é”® | é»˜è®¤å€¼ | ä½œç”¨ |
|----|--------|------|
| `consumer_key` | `""` | X å®˜æ–¹ API consumer key |
| `consumer_secret` | `""` | X å®˜æ–¹ API consumer secret |

### twitterapi_io

| é”® | é»˜è®¤å€¼ | ä½œç”¨ |
|----|--------|------|
| `api_key` | `""` | twitterapi.io API key |

### twitter

| é”® | é»˜è®¤å€¼ | ä½œç”¨ |
|----|--------|------|
| `username` | ï¼ˆå¿…å¡«ï¼‰ | ç›‘æ§çš„ Twitter è´¦å·ï¼ˆè·å–å…³æ³¨åˆ—è¡¨ï¼‰ |
| `tweets_per_user` | `20` | æ¯ä¸ªç”¨æˆ·æœ€å¤šä¿ç•™çš„æ¨æ–‡æ•° |
| `exclude_replies` | `true` | æ’é™¤å›å¤ |
| `exclude_retweets` | `true` | æ’é™¤è½¬æ¨ |
| `custom_accounts` | `[]` | é¢å¤–ç›‘æ§çš„è´¦å·åˆ—è¡¨ |
| `exclude_users` | `[]` | æ’é™¤çš„ç”¨æˆ·ååˆ—è¡¨ |

### output

| é”® | é»˜è®¤å€¼ | ä½œç”¨ |
|----|--------|------|
| `directory` | ï¼ˆå¿…å¡«ï¼‰ | è¾“å‡ºæ ¹ç›®å½• |
| `formats` | `["markdown", "json"]` | é…ç½®é¡¹å­˜åœ¨ä½†ä»£ç ä¸­å§‹ç»ˆåŒæ—¶ç”Ÿæˆä¸¤ç§ |
| `create_summary` | `true` | é…ç½®é¡¹å­˜åœ¨ä½†ä»£ç ä¸­æœªæ£€æŸ¥ |

### filters

| é”® | é»˜è®¤å€¼ | ä½œç”¨ |
|----|--------|------|
| `enabled` | `true` | è¿‡æ»¤æ€»å¼€å…³ |
| `keywords.include` | `[]` | åŒ…å«å…³é”®è¯ï¼ˆOR é€»è¾‘ï¼Œå¤§å°å†™ä¸æ•æ„Ÿï¼‰ |
| `keywords.exclude` | `[]` | æ’é™¤å…³é”®è¯ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰ |
| `min_likes` | `0` | æœ€ä½ç‚¹èµæ•° |
| `min_retweets` | `0` | æœ€ä½è½¬å‘æ•° |
| `language` | `"all"` | è¯­è¨€è¿‡æ»¤ï¼ˆ`"all"` = ä¸è¿‡æ»¤ï¼‰ |

### ai_summary

| é”® | é»˜è®¤å€¼ | ä½œç”¨ |
|----|--------|------|
| `enabled` | `true` | å¯ç”¨ AI æ€»ç»“ |
| `ai_filter` | `true` | Claude åˆ¤æ–­ç›¸å…³æ€§ï¼ˆè·³è¿‡å…³é”®è¯è¿‡æ»¤ï¼‰ |
| `style` | `"standard"` | `concise` / `standard` / `advanced` |
| `custom_prompt` | `""` | è¿½åŠ åˆ° prompt çš„è‡ªå®šä¹‰æŒ‡ä»¤ |
| `base_url` | `"https://api.anthropic.com"` | API åœ°å€ |
| `api_key` | `""` | API Keyï¼ˆä¹Ÿæ£€æŸ¥ `ANTHROPIC_AUTH_TOKEN`ã€`ANTHROPIC_API_KEY` ç¯å¢ƒå˜é‡ï¼‰ |
| `model` | `"claude-sonnet-4-5-20250929"` | æ¨¡å‹ |
| `max_tokens` | `4096` | æ¯æ¬¡è°ƒç”¨æœ€å¤§è¾“å‡º tokens |
| `max_input_tokens` | `150000` | è¾“å…¥é¢„ç®—ï¼Œå†³å®šæ‰¹æ¬¡åˆ†å‰² |

### trending_search

| é”® | é»˜è®¤å€¼ | ä½œç”¨ |
|----|--------|------|
| `enabled` | `true` | å¯ç”¨çƒ­é—¨æœç´¢ |
| `queries` | 6 ç»„é»˜è®¤æŸ¥è¯¢ | å¤šç»„ Twitter é«˜çº§æœç´¢æŸ¥è¯¢ |
| `query` | ï¼ˆæ— ï¼‰ | æ—§æ ¼å¼å•æŸ¥è¯¢ï¼ˆ`queries` ä¸å­˜åœ¨æ—¶çš„å›é€€ï¼‰ |
| `min_views` | `1000` | çƒ­é—¨æ¨æ–‡æœ€ä½æµè§ˆé‡ |
| `max_tweets` | `50` | çƒ­é—¨æ¨æ–‡æœ€å¤§è¿”å›æ•° |

### push

| é”® | é»˜è®¤å€¼ | ä½œç”¨ |
|----|--------|------|
| `enabled` | `false` | å¯ç”¨ Telegram æ¨é€ |
| `telegram.bot_token` | `""` | Bot Token |
| `telegram.chat_id` | `""` | Chat ID |
| `telegram.proxy` | `""` | HTTP ä»£ç†ï¼ˆTelegram è¢«å¢™éœ€è¦ï¼‰ |

### notifications

| é”® | é»˜è®¤å€¼ | ä½œç”¨ |
|----|--------|------|
| `enabled` | `true` | å¯ç”¨ macOS é€šçŸ¥ |
| `on_new_tweets` | `true` | å‘ç°æ–°æ¨æ–‡æ—¶é€šçŸ¥ |
| `on_keywords_matched` | `true` | é…ç½®é¡¹å­˜åœ¨ä½†ä»£ç ä¸­æœªæ£€æŸ¥ |
| `sound` | `"Glass"` | é€šçŸ¥å£°éŸ³ |
| `threshold` | `1` | è§¦å‘é€šçŸ¥çš„æœ€ä½æ¨æ–‡æ•° |

### advanced

| é”® | é»˜è®¤å€¼ | ä½œç”¨ |
|----|--------|------|
| `max_followings` | `0` | è·å–å…³æ³¨åˆ—è¡¨ä¸Šé™ï¼ˆ0 = æ— é™åˆ¶ï¼‰ |
| `followings_cache_hours` | `24` | å…³æ³¨åˆ—è¡¨ç¼“å­˜æ—¶é•¿ï¼ˆå°æ—¶ï¼‰ |
| `timeout_seconds` | `30` | HTTP è¯·æ±‚è¶…æ—¶ |
| `retry_attempts` | `3` | HTTP è¯·æ±‚é‡è¯•æ¬¡æ•° |
| `deduplicate` | `true` | å¯ç”¨æ¨æ–‡å»é‡ |
| `state_file` | `.twitter_watchdog_state.json` | å»é‡çŠ¶æ€æ–‡ä»¶è·¯å¾„ |

### schedule

| é”® | é»˜è®¤å€¼ | ä½œç”¨ |
|----|--------|------|
| `interval_hours` | `1` | é…ç½®é¡¹å­˜åœ¨ä½†ä»£ç ä¸­æœªä½¿ç”¨ |

---

## 6. å®Œæ•´æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 1: Scrape                                          â”‚
â”‚                                                          â”‚
â”‚  twitterapi.io â†’ å…³æ³¨åˆ—è¡¨ï¼ˆç¼“å­˜ 24hï¼‰                      â”‚
â”‚  + custom_accounts åˆå¹¶                                   â”‚
â”‚  â†’ é€ç”¨æˆ·: twitterapi.io/user/last_tweetsï¼ˆæŒ‰æ—¶é—´ç¿»é¡µï¼‰    â”‚
â”‚  â†’ MD5 å»é‡ï¼ˆstate æ–‡ä»¶ï¼‰                                  â”‚
â”‚  â†’ çƒ­é—¨æœç´¢: 6 ç»„ Ã— 2 æ’åº = 12 æ¬¡ API è°ƒç”¨               â”‚
â”‚  â†’ è·¨ç»„å»é‡ + ä¸å…³æ³¨åˆ—è¡¨äº¤å‰å»é‡                            â”‚
â”‚  â†’ output/raw/<ts>.json                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 2: Analyze                                         â”‚
â”‚                                                          â”‚
â”‚  â†’ åŠ è½½ raw JSON                                         â”‚
â”‚  â†’ æ—¶é—´çª—å£è¿‡æ»¤                                           â”‚
â”‚  â†’ å…³é”®è¯é¢„è¿‡æ»¤ï¼ˆai_filter=true æ—¶è·³è¿‡ï¼‰                    â”‚
â”‚  â†’ æ”¶é›†æ¨æ–‡å›¾ç‰‡ URL                                       â”‚
â”‚  â†’ [Pass 1] Claude ç­›é€‰ â†’ ai_tweet_ids + urgent_ids      â”‚
â”‚     æ‰¹æ¬¡åˆ†å‰²: 0.4 tok/charï¼Œé¢„ç®— 148k tokens               â”‚
â”‚     å¤±è´¥é‡è¯•: äºŒåˆ†æ‹†åˆ†é€’å½’                                  â”‚
â”‚  â†’ [Pass 2] Claude æ€»ç»“ï¼ˆä»…ç­›é€‰é€šè¿‡çš„æ¨æ–‡ï¼‰                  â”‚
â”‚     é£æ ¼: concise / standard / advanced                   â”‚
â”‚     + custom_prompt æ³¨å…¥                                  â”‚
â”‚  â†’ å•æ‰¹æ¬¡: æ ¡éªŒæ€»ç»“                                       â”‚
â”‚  â†’ å¤šæ‰¹æ¬¡: åˆå¹¶æ€»ç»“                                       â”‚
â”‚  â†’ output/analysis/<ts>.json                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Layer 3: Report                                          â”‚
â”‚                                                          â”‚
â”‚  â†’ åŠ è½½ analysis JSON                                    â”‚
â”‚  â†’ å•æ–‡ä»¶: ç›´æ¥ä½¿ç”¨ summary                               â”‚
â”‚  â†’ å¤šæ–‡ä»¶ï¼ˆå‘¨æœŸæŠ¥å‘Šï¼‰:                                     â”‚
â”‚     è§£ææ¡ç›® â†’ URL å»é‡ â†’ Claude æ•´åˆ                      â”‚
â”‚  â†’ ä¸‹è½½æ¨æ–‡å›¾ç‰‡                                           â”‚
â”‚  â†’ æ’å…¥å›¾ç‰‡åˆ° summary                                     â”‚
â”‚  â†’ ç”Ÿæˆ HTMLï¼ˆè‡ªåŒ…å«ï¼Œæ·±è‰²/æµ…è‰²ä¸»é¢˜ï¼Œç²˜æ€§å¯¼èˆªï¼‰              â”‚
â”‚  â†’ ç”Ÿæˆ Markdown                                         â”‚
â”‚  â†’ æ›´æ–° latest.html                                      â”‚
â”‚  â†’ macOS é€šçŸ¥                                            â”‚
â”‚  â†’ Telegram æ¨é€ï¼ˆæœ¬æœŸè¦ç‚¹ï¼‰                               â”‚
â”‚  â†’ output/reports/<ts>.html + .md                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å·²çŸ¥çš„æœªç”Ÿæ•ˆé…ç½® / æœªè°ƒç”¨ä»£ç 

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| `output.formats` | ä»£ç å§‹ç»ˆç”Ÿæˆ HTML + MDï¼Œä¸æ£€æŸ¥æ­¤é…ç½® |
| `output.create_summary` | ä»£ç ä¸­æœªæ£€æŸ¥ |
| `notifications.on_keywords_matched` | ä»£ç ä¸­æœªæ£€æŸ¥ |
| `schedule.interval_hours` | ä»£ç ä¸­æœªä½¿ç”¨ |
| `push_urgent()` æ–¹æ³• | å­˜åœ¨ä½† `run_pipeline` æœªè°ƒç”¨ï¼Œ`urgent_ids` åªä¿å­˜åˆ° JSON |
